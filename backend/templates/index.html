<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <title>ìœ¡ì˜ì „ ì‹¤ì‹œê°„ ê²€ìƒ‰ê¸°</title>

  <!-- âœ… ëª¨ë°”ì¼ í™•ëŒ€/ì¶•ì†Œ ë¹„í™œì„±í™” + ê³ ì • ìŠ¤ì¼€ì¼ ì„¤ì • -->
  <meta name="viewport" content="width=480, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />

  <style>
    body {
      font-family: Arial, sans-serif;
      padding: 12px;
      max-width: 480px;
      margin: 0 auto;
      box-sizing: border-box;
    }

    h1 {
      margin-top: 60px;
      font-size: 20px;
    }

    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 16px;
      font-size: 14px;
    }

    th, td {
      border: 1px solid #ccc;
      padding: 6px;
      text-align: center;
    }

    input, select, button {
      padding: 6px;
      margin: 4px 0;
      font-size: 14px;
    }

    .autocomplete-list {
      border: 1px solid #ccc;
      max-height: 100px;
      overflow-y: auto;
      position: absolute;
      background: white;
      z-index: 99;
      display: none;
      width: calc(100% - 24px);
    }

    .autocomplete-item {
      padding: 6px;
      cursor: pointer;
    }

    .autocomplete-item:hover {
      background: #f0f0f0;
    }

    .top-bar {
      position: fixed;
      top: 10px;
      left: 10px;
      background: #f9f9f9;
      padding: 8px 16px;
      border-radius: 6px;
      box-shadow: 0 0 5px rgba(0, 0, 0, 0.1);
      z-index: 999;
      font-size: 14px;
    }

    label {
      font-size: 14px;
    }
  </style>
</head>

<body>

  <div class="top-bar">
    <a href="/" style="margin-right: 12px; text-decoration: none; font-weight: bold;">ğŸª ìœ¡ì˜ì „</a>
    <a href="/saton" style="text-decoration: none; font-weight: bold;">ğŸ“¨ ì‚¬í†µíŒ”ë‹¬</a>
  </div>

  <h1>ìœ¡ì˜ì „ ì‹¤ì‹œê°„ ê²€ìƒ‰</h1>

  <label for="server">ì„œë²„ ì„ íƒ:</label>
  <select id="server">
    <option>ë°±í˜¸</option>
    <option>ì£¼ì‘</option>
    <option>í˜„ë¬´</option>
    <option>ì²­ë£¡</option>
  </select>

  <br><br>

  <label for="keyword">ì•„ì´í…œ ì´ë¦„:</label>
  <input type="text" id="keyword" placeholder="ì˜ˆ: ì²œìƒì´ˆ" autocomplete="off">
  <label><input type="checkbox" id="exactSearch"> ì •í™•í•œ ì´ë¦„ë§Œ ê²€ìƒ‰</label>

  <div id="autocomplete" class="autocomplete-list"></div>

  <button onclick="addToWatchlist()">â• ê´€ì‹¬ ëª©ë¡ì— ì¶”ê°€</button>

  <h2>ğŸ” ê²€ìƒ‰ ê²°ê³¼</h2>
  <table>
    <thead>
      <tr>
        <th>ì•„ì´í…œëª…</th>
        <th>íŒë§¤ì</th>
        <th>ìˆ˜ëŸ‰</th>
        <th>ê°€ê²©</th>
      </tr>
    </thead>
    <tbody id="search-result-table"></tbody>
  </table>

  <h2>ğŸ“Œ ê´€ì‹¬ ëª©ë¡ ì‹œì„¸ ë¶„ì„</h2>
  <table>
    <thead>
      <tr>
        <th>ì•„ì´í…œëª…</th>
        <th>ì„œë²„</th>
        <th>ìµœì €ê°€</th>
        <th>í‰ê· ê°€</th>
        <th>ì‚­ì œ</th>
      </tr>
    </thead>
    <tbody id="watchlist-table"></tbody>
  </table>

  <script>
    const serverSelect = document.getElementById("server");
    const keywordInput = document.getElementById("keyword");
    const autocompleteBox = document.getElementById("autocomplete");
    const exactCheckbox = document.getElementById("exactSearch");
    const resultTable = document.getElementById("watchlist-table");
    const searchResultTable = document.getElementById("search-result-table");

    serverSelect.value = localStorage.getItem("selectedServer") || "í˜„ë¬´";
    serverSelect.addEventListener("change", () => {
      localStorage.setItem("selectedServer", serverSelect.value);
      performSearch();
    });

    let autocompleteItems = [];
    let selectedIndex = -1;
    let autocompleteEntered = false;
    let pendingInitialArrowDown = false;

    keywordInput.addEventListener("keydown", (e) => {
      if (e.key === "ArrowDown") {
        e.preventDefault();
        if (!autocompleteEntered) {
          pendingInitialArrowDown = true;
          performSearch();
        } else if (autocompleteItems.length > 0) {
          selectedIndex = (selectedIndex + 1) % autocompleteItems.length;
          updateHighlight();
        }
      } else if (e.key === "ArrowUp" && autocompleteItems.length) {
        e.preventDefault();
        selectedIndex = (selectedIndex - 1 + autocompleteItems.length) % autocompleteItems.length;
        updateHighlight();
      } else if (e.key === "Enter" && selectedIndex >= 0) {
        e.preventDefault();
        const selected = autocompleteItems[selectedIndex];
        if (selected) {
          keywordInput.value = selected.textContent;
          clearAutocomplete();
          performSearch();
        }
      }
    });

    keywordInput.addEventListener("input", () => {
      performSearch();
    });

    function clearAutocomplete() {
      autocompleteBox.style.display = "none";
      autocompleteBox.innerHTML = "";
      autocompleteItems = [];
      selectedIndex = -1;
      autocompleteEntered = false;
    }

    async function performSearch() {
      const keyword = keywordInput.value.trim();
      const server = serverSelect.value;
      const exact = exactCheckbox.checked ? "true" : "false";

      clearAutocomplete();

      try {
        let res;
        if (!keyword) {
          res = await fetch(`/search?server=${server}`);
        } else {
          res = await fetch(`/search?keyword=${encodeURIComponent(keyword)}&server=${server}&exact=${exact}`);
        }
        const data = await res.json();
        renderSearchResults(data, !!keyword);

        if (keyword) {
          const unique = [...new Set(data.map(d => d.itemName))].slice(0, 10);
          if (unique.length > 0) {
            autocompleteBox.style.display = "block";
          }

          unique.forEach((name, i) => {
            const div = document.createElement("div");
            div.className = "autocomplete-item";
            div.textContent = name;

            div.addEventListener("mouseenter", () => {
              selectedIndex = i;
              updateHighlight();
            });

            div.onclick = () => {
              keywordInput.value = name;
              clearAutocomplete();
              performSearch();
            };
            autocompleteBox.appendChild(div);
            autocompleteItems.push(div);
          });

          if (unique.includes(keyword)) {
            clearAutocomplete();
          } else {
            updateHighlight();
          }

          if (pendingInitialArrowDown && !autocompleteEntered && autocompleteItems.length > 0) {
            autocompleteEntered = true;
            selectedIndex = 0;
            updateHighlight();
            pendingInitialArrowDown = false;
          }
        }
      } catch (err) {
        console.error("âŒ ê²€ìƒ‰ ì‹¤íŒ¨:", err);
      }
    }

    function renderSearchResults(data, shouldSort = false) {
      searchResultTable.innerHTML = "";

      if (!data || data.length === 0) {
        searchResultTable.innerHTML = `<tr><td colspan="4" style="color: gray;">ê²€ìƒ‰ ê²°ê³¼ ì—†ìŒ ğŸ˜¥</td></tr>`;
        return;
      }

      if (shouldSort) {
        data.sort((a, b) => a.price - b.price);
      }

      data.forEach(row => {
        const tr = document.createElement("tr");
        tr.innerHTML = `
          <td><strong>${row.itemName}</strong></td>
          <td style="color:blue">${row.characterName}</td>
          <td>${row.quantity}</td>
          <td>${row.price.toLocaleString()}</td>
        `;
        searchResultTable.appendChild(tr);
      });
    }

    function updateHighlight() {
      autocompleteItems.forEach((item, i) => {
        const isSelected = i === selectedIndex;
        item.style.background = isSelected ? "#ddd" : "#fff";
        if (isSelected) {
          item.scrollIntoView({ block: "nearest" });
        }
      });
    }

    function getLocalWatchlist() {
      return JSON.parse(localStorage.getItem("localWatchlist") || "[]");
    }

    function setLocalWatchlist(data) {
      localStorage.setItem("localWatchlist", JSON.stringify(data));
    }

    async function refreshWatchlistDisplay() {
      const watchlist = getLocalWatchlist();
      resultTable.innerHTML = "";

      for (const item of watchlist) {
        try {
          const res = await fetch(`/search?keyword=${encodeURIComponent(item.item)}&server=${item.server}`);
          const data = await res.json();
          const prices = data.map(d => d.price);
          const avg = prices.length ? Math.floor(prices.reduce((a, b) => a + b) / prices.length) : "ì—†ìŒ";
          const lowest = prices.length ? Math.min(...prices) : "ì—†ìŒ";

          const row = document.createElement("tr");
          row.innerHTML = `
            <td>${item.item}</td>
            <td>${item.server}</td>
            <td>${typeof lowest === "number" ? lowest.toLocaleString() : lowest}</td>
            <td>${typeof avg === "number" ? avg.toLocaleString() : avg}</td>
            <td><button onclick="removeFromWatchlist('${item.item}', '${item.server}')">âŒ</button></td>
          `;
          resultTable.appendChild(row);
        } catch (err) {
          console.error("âŒ ê´€ì‹¬ëª©ë¡ ë¡œë”© ì‹¤íŒ¨:", err);
        }
      }
    }

    function addToWatchlist() {
      const item = keywordInput.value.trim();
      const server = serverSelect.value;
      if (!item) return;

      const list = getLocalWatchlist();
      if (!list.find(w => w.item === item && w.server === server)) {
        list.push({ item, server });
        setLocalWatchlist(list);
        refreshWatchlistDisplay();
      }
    }

    function removeFromWatchlist(item, server) {
      const list = getLocalWatchlist().filter(w => !(w.item === item && w.server === server));
      setLocalWatchlist(list);
      refreshWatchlistDisplay();
    }

    window.addEventListener("load", () => {
      performSearch();
      refreshWatchlistDisplay();
    });

    setInterval(refreshWatchlistDisplay, 60000);
  </script>
</body>

</html>
